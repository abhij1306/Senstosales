# BACKEND ARCHITECTURE
> **Status**: Auto-Generated by Architecture Steward
> **Last Updated**: 2025-12-28

## Core Structure
The backend follows a strict Layered Architecture enforced by `architecture-manifest.yaml`.

### 1. Application Layer (`app/`)
- **Routers** (`app/routers/`): Entry points for all API endpoints. RESTful design.
- **Services** (`app/services/`): Business logic domain. Pure Python.
- **Repositories** (`app/repositories/`): Database access layer. SQLAlchemy isolation.
- **Models** (`app/models.py`): Pydantic Schemas and SQLAlchemy Models.

### 2. Infrastructure Layer
- **Database**: SQLite (`db/business.db`).
- **Migrations**: SQL-based version control (`migrations/`).
- **Scripts**: DevOps and Maintenance (`scripts/`).

### 3. Invariants
- No UI generation in backend.
- No direct SQL execution outside repositories/migrations.
- No "utils" folder (Legacy violation detected: `app/utils` - remediation pending).

## Data Flow
Request -> Router -> Service -> Repository -> Database
Response <- Model <- Service <- Repository <- Database

## Business Logic Invariants (Legacy: SYSTEM_INVARIANTS)

### 1. Purchase Order (PO)
- **PO-1 (Immutable)**: `po_number` cannot be changed after creation.
- **PO-2 (Qty Bounds)**: `Σ(delivery.dely_qty) ≤ po_item.ord_qty`.
- **PO-3 (Idempotency)**: Re-uploads must UPSERT and preserve links.

### 2. Delivery Challan (DC)
- **DC-1 (Dispatch Bounds)**: `dispatch_qty ≤ (lot_ordered - dispatched)`.
- **DC-2 (Single Invoice)**: One DC triggers max ONE invoice.
- **DC-3 (Integrity)**: All DCs must link to valid POs.

### 3. Invoice (INV)
- **INV-1 (Uniqueness)**: Invoice numbers must be globally unique per FY.
- **INV-2 (Server Tax)**: Taxes (CGST/SGST/IGST) calculated server-side ONLY.
- **INV-3 (Total)**: `Total = Taxable + Taxes`.
- **INV-4 (Linkage)**: Must reference at least one DC.

### 4. SRV (Receipts)
- **SRV-1 (PO Link)**: SRV must reference valid PO.
- **SRV-2 (Qty Bounds)**: `Σ(received_qty) ≤ Σ(dispatched_qty)`.
